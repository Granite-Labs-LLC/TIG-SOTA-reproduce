#!/bin/bash


#echo "SCALE_ADJUSTMENT"
#
NQ=2000
NN=10

#ST=2348587
ST=0

#DIFFICULTIES=('[200,50]' '[204,51]' '[208,52]' '[212,53]' '[216,54]' '[220,55]' '[224,56]' '[228,57]' '[232,58]' '[236,59]' '[240,60]' '[244,61]' '[248,62]' '[252,63]' '[256,64]' '[260,65]' '[264,66]' '[268,67]' '[272,68]' '[276,69]' '[280,70]' '[284,71]' '[288,72]' '[292,73]' '[296,74]' '[300,75]' '[304,76]' '[308,77]' '[312,78]' '[316,79]' '[320,80]' '[324,81]' '[328,82]' '[332,83]' '[336,84]' '[340,85]' '[344,86]' '[348,87]' '[352,88]' '[356,89]' '[360,90]' '[364,91]' '[368,92]' '[372,93]' '[376,94]' '[380,95]' '[384,96]' '[388,97]' '[392,98]' '[396,99]' '[400,100]' '[404,101]' '[408,102]' '[412,103]' '[416,104]' '[420,105]' '[424,106]' '[428,107]' '[432,108]' '[436,109]' '[440,110]' '[444,111]' '[448,112]' '[452,113]' '[456,114]' '[460,115]' '[464,116]' '[468,117]' '[472,118]' '[476,119]' '[480,120]' '[484,121]' '[488,122]' '[492,123]' '[496,124]' '[500,125]' '[504,126]' '[508,127]' '[512,128]' '[516,129]' '[520,130]' '[524,131]' '[528,132]' '[532,133]' '[536,134]' '[540,135]' '[544,136]' '[548,137]' '[552,138]' '[556,139]' '[560,140]' '[564,141]' '[568,142]' '[572,143]' '[576,144]' '[580,145]' '[584,146]' '[588,147]' '[592,148]' '[596,149]' '[600,150]' '[604,151]' '[608,152]' '[612,153]' '[616,154]' '[620,155]' '[624,156]' '[628,157]' '[632,158]' '[636,159]' '[640,160]' '[644,161]' '[648,162]' '[652,163]' '[656,164]' '[660,165]' '[664,166]' '[668,167]' '[672,168]' '[676,169]' '[680,170]' '[684,171]' '[688,172]' '[692,173]' '[696,174]' '[700,175]' '[704,176]' '[708,177]' '[712,178]' '[716,179]' '[720,180]' '[724,181]' '[728,182]' '[732,183]' '[736,184]' '[740,185]' '[744,186]' '[748,187]' '[752,188]' '[756,189]' '[760,190]' '[764,191]' '[768,192]' '[772,193]' '[776,194]' '[780,195]' '[784,196]' '[788,197]' '[792,198]' '[796,199]' '[800,200]' '[804,201]' '[808,202]' '[812,203]' '[816,204]' '[820,205]' '[824,206]' '[828,207]' '[832,208]' '[836,209]' '[840,210]' '[844,211]' '[848,212]' '[852,213]' '[856,214]' '[860,215]' '[864,216]' '[868,217]' '[872,218]' '[876,219]' '[880,220]' '[884,221]' '[888,222]' '[892,223]' '[896,224]' '[900,225]' '[904,226]' '[908,227]' '[912,228]' '[916,229]' '[920,230]' '[924,231]' '[928,232]' '[932,233]' '[936,234]' '[940,235]' '[944,236]' '[948,237]' '[952,238]' '[956,239]' '[960,240]' '[964,241]' '[968,242]' '[972,243]' '[976,244]' '[980,245]' '[984,246]' '[988,247]' '[992,248]' '[996,249]' '[1000,250]' '[1004,251]' '[1008,252]' '[1012,253]' '[1016,254]' '[1020,255]' '[1024,256]' '[1028,257]' '[1032,258]' '[1036,259]' '[1040,260]' '[1044,261]' '[1048,262]' '[1052,263]' '[1056,264]' '[1060,265]' '[1064,266]' '[1068,267]' '[1072,268]' '[1076,269]' '[1080,270]' '[1084,271]' '[1088,272]' '[1092,273]' '[1096,274]' '[1100,275]' '[1104,276]' '[1108,277]' '[1112,278]' '[1116,279]' '[1120,280]' '[1124,281]' '[1128,282]' '[1132,283]' '[1136,284]' '[1140,285]' '[1144,286]' '[1148,287]' '[1152,288]' '[1156,289]' '[1160,290]' '[1164,291]' '[1168,292]' '[1172,293]' '[1176,294]' '[1180,295]' '[1184,296]' '[1188,297]' '[1192,298]' '[1196,299]' '[1200,300]' '[1204,301]' '[1208,302]' '[1212,303]' '[1216,304]' '[1220,305]' '[1224,306]' '[1228,307]' '[1232,308]' '[1236,309]' '[1240,310]' '[1244,311]' '[1248,312]' '[1252,313]' '[1256,314]' '[1260,315]' '[1264,316]' '[1268,317]' '[1272,318]' '[1276,319]' '[1280,320]' '[1284,321]' '[1288,322]' '[1292,323]' '[1296,324]' '[1300,325]' '[1304,326]' '[1308,327]' '[1312,328]' '[1316,329]' '[1320,330]' '[1324,331]' '[1328,332]' '[1332,333]' '[1336,334]' '[1340,335]' '[1344,336]' '[1348,337]' '[1352,338]' '[1356,339]' '[1360,340]' '[1364,341]' '[1368,342]' '[1372,343]' '[1376,344]' '[1380,345]' '[1384,346]' '[1388,347]' '[1392,348]' '[1396,349]' '[1400,350]' '[1404,351]' '[1408,352]' '[1412,353]' '[1416,354]' '[1420,355]' '[1424,356]' '[1428,357]' '[1432,358]' '[1436,359]' '[1440,360]' '[1444,361]' '[1448,362]' '[1452,363]' '[1456,364]' '[1460,365]' '[1464,366]' '[1468,367]' '[1472,368]' '[1476,369]' '[1480,370]' '[1484,371]' '[1488,372]' '[1492,373]' '[1496,374]' '[1500,375]' '[1504,376]' '[1508,377]' '[1512,378]' '[1516,379]' '[1520,380]' '[1524,381]' '[1528,382]' '[1532,383]' '[1536,384]' '[1540,385]' '[1544,386]' '[1548,387]' '[1552,388]' '[1556,389]' '[1560,390]' '[1564,391]' '[1568,392]' '[1572,393]' '[1576,394]' '[1580,395]' '[1584,396]' '[1588,397]' '[1592,398]' '[1596,399]' '[1600,400]' '[1604,401]' '[1608,402]' '[1612,403]' '[1616,404]' '[1620,405]' '[1624,406]' '[1628,407]' '[1632,408]' '[1636,409]' '[1640,410]' '[1644,411]' '[1648,412]' '[1652,413]' '[1656,414]' '[1600,400]' '[1604,401]' '[1608,402]' '[1612,403]' '[1616,404]' '[1620,405]' '[1624,406]' '[1628,407]' '[1632,408]' '[1636,409]' '[1640,410]' '[1644,411]' '[1648,412]' '[1652,413]' '[1656,414]' '[1660,415]' '[1664,416]' '[1668,417]' '[1672,418]' '[1676,419]' '[1680,420]' '[1684,421]' '[1688,422]' '[1692,423]' '[1696,424]' '[1700,425]' '[1704,426]' '[1708,427]' '[1712,428]' '[1716,429]' '[1720,430]' '[1724,431]' '[1728,432]' '[1732,433]' '[1736,434]' '[1740,435]' '[1744,436]' '[1748,437]' '[1752,438]' '[1756,439]' '[1760,440]' '[1764,441]' '[1768,442]' '[1772,443]' '[1776,444]' '[1780,445]' '[1784,446]' '[1788,447]' '[1792,448]' '[1796,449]' '[1800,450]' '[1804,451]' '[1808,452]' '[1812,453]' '[1816,454]' '[1820,455]' '[1824,456]' '[1828,457]' '[1832,458]' '[1836,459]' '[1840,460]' '[1844,461]' '[1848,462]' '[1852,463]' '[1856,464]' '[1860,465]' '[1864,466]' '[1868,467]' '[1872,468]' '[1876,469]' '[1880,470]' '[1884,471]' '[1888,472]' '[1892,473]' '[1896,474]' '[1900,475]' '[1904,476]' '[1908,477]' '[1912,478]' '[1916,479]' '[1920,480]' '[1924,481]' '[1928,482]' '[1932,483]' '[1936,484]' '[1940,485]' '[1944,486]' '[1948,487]' '[1952,488]' '[1956,489]' '[1960,490]' '[1964,491]' '[1968,492]' '[1972,493]' '[1976,494]' '[1980,495]' '[1984,496]' '[1988,497]' '[1992,498]' '[1996,499]' '[2000,500]' '[2000,500]' '[2004,501]' '[2008,502]' '[2012,503]' '[2016,504]' '[2020,505]' '[2024,506]' '[2028,507]' '[2032,508]' '[2036,509]' '[2040,510]' '[2044,511]' '[2048,512]' '[2052,513]' '[2056,514]' '[2060,515]' '[2064,516]' '[2068,517]' '[2072,518]' '[2076,519]' '[2080,520]' '[2084,521]' '[2088,522]' '[2092,523]' '[2096,524]' '[2100,525]' '[2104,526]' '[2108,527]' '[2112,528]' '[2116,529]' '[2120,530]' '[2124,531]' '[2128,532]' '[2132,533]' '[2136,534]' '[2140,535]' '[2144,536]' '[2148,537]' '[2152,538]' '[2156,539]' '[2160,540]' '[2164,541]' '[2168,542]' '[2172,543]' '[2176,544]' '[2180,545]' '[2184,546]' '[2188,547]' '[2192,548]' '[2196,549]' '[2200,550]' '[2204,551]' '[2208,552]' '[2212,553]' '[2216,554]' '[2220,555]' '[2224,556]' '[2228,557]' '[2232,558]' '[2236,559]' '[2240,560]' '[2244,561]' '[2248,562]' '[2252,563]' '[2256,564]' '[2260,565]' '[2264,566]' '[2268,567]' '[2272,568]' '[2276,569]' '[2280,570]' '[2284,571]' '[2288,572]' '[2292,573]' '[2296,574]' '[2300,575]' '[2304,576]' '[2308,577]' '[2312,578]' '[2316,579]' '[2320,580]' '[2324,581]' '[2328,582]' '[2332,583]' '[2336,584]' '[2340,585]' '[2344,586]' '[2348,587]' '[2352,588]' '[2356,589]' '[2360,590]' '[2364,591]' '[2368,592]' '[2372,593]' '[2376,594]' '[2380,595]' '[2384,596]' '[2388,597]' '[2392,598]' '[2396,599]' '[2400,600]' '[2404,601]' '[2408,602]' '[2412,603]' '[2416,604]' '[2420,605]' '[2424,606]' '[2428,607]' '[2432,608]' '[2436,609]' '[2440,610]' '[2444,611]' '[2448,612]' '[2452,613]' '[2456,614]' '[2460,615]' '[2464,616]' '[2468,617]' '[2472,618]' '[2476,619]' '[2480,620]' '[2484,621]' '[2488,622]' '[2492,623]' '[2496,624]' '[2500,625]')
DIFFICULTIES=('[200,50]' '[300,75]' '[400,100]' '[500,125]' '[700,175]' '[852,213]' '[1000,250]' '[1200,300]' '[1420,355]' '[1640,410]' '[1880,470]' '[2000,500]' '[2100,525]' '[2200,550]' '[2336,584]' '[2400,600]' '[2500,625]' '[2600,650]' '[2700,675]' '[2800,700]' '[2900,725]' '[3000,750]')

F=tmpfile1

: > $F

echo "start_nonce,scale_adjustment,queries_per_nonce,queries_per_second,recall_percent,actual_scale_factor"

for DIFFICULTY in "${DIFFICULTIES[@]}"; do

  #for S in 0.6 0.65 0.66 0.67 0.68 0.69 0.7 0.74 0.78 0.8 1.0
  #for S in 0.4 0.5 0.6 0.65 0.66 0.67 0.68 0.69 0.7 0.74 0.78 0.8 1.0 1.1 1.2 1.5 1.8; do
  #for S in 1.0 1.1 1.2 1.5 1.8; do
  #for S in 0.05 0.08 0.1 0.2 0.25 0.3 0.35 0.4 0.5 0.6 0.65 0.66 0.67 0.68 0.69 0.7 0.74 0.78 0.8 1.0 1.1 1.2 1.5 1.8; do
  S=1.0
  #echo "scale adjustment: $S"

  for ST in 0 2348587; do

    export SCALE_ADJUSTMENT=$S

    NQ=$(echo "$DIFFICULTY" | tr -d '[]' | cut -f1 -d ',')

    scripts/test_algorithm_timer --start ${ST} --nonces ${NN} --workers 1 stat_filter ${DIFFICULTY} | egrep 'Time for |#solutions: |scale_applied:' > $F 

    T=`grep 'Time for ' $F | awk '{printf("%.3f + ", $4)}'`
    ms_per_nonce=$(echo "scale=3; ($T 0) / $NN" | bc)
    #echo $ms_per_nonce
    qps=$(echo "scale=4; (1000.0 / $ms_per_nonce) * ${NQ}.0" | bc | cut -f1 -d'.')

    N=`grep '#solutions: ' $F | sed -e '/^.*#solutions: /s///' | cut -f1 -d',' | tail -1`

    percent=$(echo "scale=2; $N / $NN" | bc)
    #percent=$(( N * 100 / NN ))
    #echo "${percent}%"

    A=`grep 'scale_applied:' $F | cut -f2 -d':' | cut -f2 -d',' | tail -1`

    echo "${ST},$S,${NQ},${qps},${percent},$A"

    # Enable this if looping through scale adjustments
    # [ "$percent" = "1.00" ] && break

  done
done

